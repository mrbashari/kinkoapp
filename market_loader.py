import sqlite3
import requests
from database import DB_NAME

def get_asset_type(symbol, name, sector):
    """ุชุดุฎุต ููุดููุฏ ููุน ุฏุงุฑุง ุจุฑ ุงุณุงุณ ูุงู ู ููุงุฏ"""
    if 'ุตูุฏูู' in name or 'ETF' in sector:
        if 'ุทูุง' in name or 'gold' in sector.lower() or symbol in ['ุทูุง', 'ุนุงุฑ', 'ุฒุฑ', 'ูุงุจ', 'ฺฏูุฌ', 'ฺฉูุฑุจุง']:
            return 'ุตูุฏูู ุทูุง (Gold)'
        elif 'ุฏุฑุขูุฏ ุซุงุจุช' in name or 'fixed' in sector.lower() or symbol in ['ุงููุช', 'ุงูุฑุงู', 'ุงุนุชูุงุฏ', 'ุขูุงู']:
            return 'ุฏุฑุขูุฏ ุซุงุจุช (Fixed Income)'
        elif 'ุฒุนูุฑุงู' in name:
            return 'ฺฉุงูุง (Commodity)'
        elif 'ูุฎุชูุท' in name:
            return 'ุตูุฏูู ูุฎุชูุท (Mixed)'
        else:
            return 'ุตูุฏูู ุณูุงู (Equity Fund)'
    elif 'ุงุฎุฒุง' in symbol or 'ุงุฑุงุฏ' in symbol:
        return 'ุงูุฑุงู ุฎุฒุงูู (Bonds)'
    else:
        return 'ุณูุงู (Stock)'

def fetch_and_update_market():
    conn = sqlite3.connect(DB_NAME)
    c = conn.cursor()
    
    print("--- ุฏุฑ ุญุงู ุงุชุตุงู ุจู ุณุฑูุฑ TSETMC ... ---")
    
    try:
        # ุฏุฑุงูุช ุงุทูุงุนุงุช ุฏุฏูโุจุงู ุจุงุฒุงุฑ (ุฑูุด ุณุฑุน)
        # ุงู ุขุฏุฑุณ ุฏุชุง ุฎุงู ู ุณุจฺฉ ุฏุฏูโุจุงู ุฑุง ุจุฑูโฺฏุฑุฏุงูุฏ
        url = "http://old.tsetmc.com/tsev2/data/MarketWatchPlus.aspx?h=0&r=0"
        response = requests.get(url, timeout=10)
        content = response.text
        
        # ูพุงุฑุณ ฺฉุฑุฏู ุฏุชุง ุนุฌุจ TSETMC
        # ูุฑูุช: ุจุฎุดโูุง ุจุง @ ู ุฑุฏูโูุง ุจุง ; ุฌุฏุง ูโุดููุฏ
        sections = content.split('@')
        if len(sections) > 2:
            raw_data = sections[2] # ุจุฎุด ุณูู ุดุงูู ุงุทูุงุนุงุช ููุงุฏูุงุณุช
            rows = raw_data.split(';')
            
            count = 0
            for row in rows:
                cols = row.split(',')
                if len(cols) > 20:
                    # ุงุณุชุฎุฑุงุฌ ุณุชููโูุง ููู
                    symbol = cols[2]        # ููุงุฏ (ูุซูุง ูููุงุฏ)
                    name = cols[3]          # ูุงู ุดุฑฺฉุช
                    close_price = float(cols[5]) # ููุช ูพุงุงู
                    last_price = float(cols[6])  # ุขุฎุฑู ูุนุงููู
                    # TSETMC ุตูุนุช ุฑุง ฺฉุฏ ุนุฏุฏ ูโุฏูุฏุ ูุนูุง ุงุณูุด ุฑุง ฺฉู ูโฺฏุฐุงุฑู ูฺฏุฑ ุงูฺฉู ูุณุช ฺฉุฏูุง ุฑุง ุฏุงุดุชู ุจุงุดู
                    # ุจุฑุง ุณุงุฏฺฏ ูุนูุง ุตูุนุช ุฑุง ุฌูุฑุงู ูโุฒูู ู ููุน ุฑุง ุชุดุฎุต ูโุฏูู
                    sector_name = "ุจุงุฒุงุฑ ุจูุฑุณ" 
                    
                    asset_type = get_asset_type(symbol, name, sector_name)
                    
                    # ูุญุงุณุจู ูุณุจุช P/E (ุงฺฏุฑ ููุฌูุฏ ุจุงุดุฏ ุฏุฑ ุณุชููโูุง ุฌููุชุฑ ุงุณุชุ ูุนูุง ุตูุฑ)
                    pe = 0 
                    
                    c.execute('''
                        INSERT OR REPLACE INTO market_prices 
                        (symbol, company_name, sector, asset_type, last_price, close_price_yesterday, pe_ratio)
                        VALUES (?, ?, ?, ?, ?, ?, ?)
                    ''', (symbol, name, sector_name, asset_type, last_price, close_price, pe))
                    
                    count += 1
            
            print(f"โ ููููุช! {count} ููุงุฏ ุงุฒ TSETMC ุฏุฑุงูุช ู ุฐุฎุฑู ุดุฏ.")

    except Exception as e:
        print(f"โ๏ธ ุฎุท ุฏุฑ ุงุฑุชุจุงุท ุจุง TSETMC: {e}")
        print("๐ ุฏุฑ ุญุงู ุจุงุฑฺฏุฐุงุฑ ูุณุช ุขููุงู (ูพุดุชุจุงู)...")
        load_offline_backup(c)

    conn.commit()
    conn.close()

def load_offline_backup(c):
    """ูุณุช ุฏุณุช ุงุฒ ูููโุชุฑู ููุงุฏูุง ุจุฑุง ุฒูุงู ฺฉู ุงูุชุฑูุช ูุณุช"""
    backup_data = [
        # ุณูุงู
        ('ูููุงุฏ', 'ูููุงุฏ ูุจุงุฑฺฉู', 'ููุฒุงุช ุงุณุงุณ', 'ุณูุงู', 5400),
        ('ููู', 'ูุณ ุงุฑุงู', 'ููุฒุงุช ุงุณุงุณ', 'ุณูุงู', 7200),
        ('ุฎูุฏุฑู', 'ุงุฑุงู ุฎูุฏุฑู', 'ุฎูุฏุฑู', 'ุณูุงู', 2800),
        ('ุฎุณุงูพุง', 'ุณุงูพุง', 'ุฎูุฏุฑู', 'ุณูุงู', 2400),
        ('ุดุณุชุง', 'ุชุงูู ุงุฌุชูุงุน', 'ฺูุฏ ุฑุดุชูโุง', 'ุณูุงู', 1100),
        ('ูุจููุช', 'ุจุงูฺฉ ููุช', 'ุจุงูฺฉโูุง', 'ุณูุงู', 2100),
        ('ูุงุฑุณ', 'ููุฏูฺฏ ุฎูุฌ ูุงุฑุณ', 'ุดูุง', 'ุณูุงู', 12000),
        ('ุดูพูุง', 'ูพุงูุงุด ููุช ุงุตููุงู', 'ูุฑุขูุฑุฏู ููุช', 'ุณูุงู', 8500),
        
        # ุตูุฏูู ุทูุง
        ('ุนุงุฑ', 'ุตูุฏูู ุทูุง ููุฏ', 'ุตูุฏูู ุทูุง', 'ุตูุฏูู ุทูุง', 11000),
        ('ุทูุง', 'ุตูุฏูู ูพุดุชูุงูู ููุชูุณ', 'ุตูุฏูู ุทูุง', 'ุตูุฏูู ุทูุง', 12500),
        ('ุฒุฑ', 'ุตูุฏูู ุฒุฑ ุงูุดุงู', 'ุตูุฏูู ุทูุง', 'ุตูุฏูู ุทูุง', 10500),
        
        # ุตูุฏูู ุฏุฑุขูุฏ ุซุงุจุช
        ('ุงูุฑุงู', 'ุฏุฑุขูุฏ ุซุงุจุช ุงูุฑุงู', 'ETF ุฏุฑุขูุฏ ุซุงุจุช', 'ุฏุฑุขูุฏ ุซุงุจุช', 14500),
        ('ุงููุช', 'ุฏุฑุขูุฏ ุซุงุจุช ุงููุช', 'ETF ุฏุฑุขูุฏ ุซุงุจุช', 'ุฏุฑุขูุฏ ุซุงุจุช', 13200),
        ('ุงุนุชูุงุฏ', 'ุฏุฑุขูุฏ ุซุงุจุช ุงุนุชูุงุฏ', 'ETF ุฏุฑุขูุฏ ุซุงุจุช', 'ุฏุฑุขูุฏ ุซุงุจุช', 18000),
        
        # ุตูุฏูู ุณูุงู
        ('ุขฺฏุงุณ', 'ุตูุฏูู ูุณุช ุจุฎุด', 'ETF ุณูุงู', 'ุตูุฏูู ุณูุงู', 16000),
        ('ุงุทูุณ', 'ุตูุฏูู ุงุทูุณ ููุฏ', 'ETF ุณูุงู', 'ุตูุฏูู ุณูุงู', 15500),
    ]
    
    for item in backup_data:
        c.execute('''
            INSERT OR REPLACE INTO market_prices 
            (symbol, company_name, sector, asset_type, last_price, close_price_yesterday, pe_ratio)
            VALUES (?, ?, ?, ?, ?, ?, ?)
        ''', (item[0], item[1], item[2], item[3], item[4], item[4], 6.0))
        
    print("โ ูุณุช ุขููุงู ุดุงูู ุตูุฏููโูุง ู ุณูุงู ุจุฒุฑฺฏ ุจุงุฑฺฏุฐุงุฑ ุดุฏ.")

if __name__ == "__main__":
    fetch_and_update_market()